# 《DeepSeek 网页版对话定位插件》PRD v1.1

**文档状态**：Ready for Dev

**目标版本**：V1（只做“向上”）

**适配对象**：DeepSeek 网页版聊天页

---

## 1. 背景

DeepSeek 网页版的一条 AI 回复往往是**两段式**的：

1. （可选）“已深度思考（用时 XX 秒）”这一坨推理内容
2. 真正给用户看的 **Markdown 正文**

用户的典型行为是：发了一个问题 → 看见它开始回了 → 切到别的 tab 干活 → 回来时这一条已经生成到中/下段了，或者生成了一大坨，**不知道这一条到底是从哪里开始说的**，只能一直往上手动滚，边看边找，体验很差。

我们想做一个浏览器插件，在用户回到页⾯、或者看到一大坨内容的时候，**按一下（或点一下）就能把“这一轮真正要看的位置”滚到眼前**，而且要适配 DeepSeek 的“深度思考 + 正文”结构。

---

## 2. 产品目标

1. 在 `https://chat.deepseek.com/*` 页面里提供一个**向上定位**能力；
2. 用户按下 `Shift + ↑` 或点击右下角悬浮按钮，就能**滚动到当前这轮对话里“应该看的地方”**；
3. 有“深度思考”时要自动跳过，把**正文部分滚出来**；
4. 没有“深度思考”或正文还没出来时，要**能优雅退化**，而不是报错；
5. 滚动方向始终是“向上”，**不能因为要看正文反而往下滚**；
6. 状态以**单页面**为单位，不做跨 tab / 跨端同步。

---

## 3. 适用范围（Scope）

- **浏览器**：Chrome，Manifest V3
- **生产匹配域名**：`https://chat.deepseek.com/*`
- **开发测试可放宽为**：
    - `https://chat.deepseek.com/*`
    - `http://localhost/*`
    - `file://*/*`
        
        这样可以用你本地导出的 HTML 测试
        
- **页面范围**：DeepSeek 的**对话页面**，只对对话区域生效

**本版不做：**

- 不做自动“tab 回来就滚动”的行为
- 不做多站点（ChatGPT、Claude、Poe…）
- 不做快捷键自定义
- 不做横向滚动
- 悬浮按钮“隐藏/个性化”留到下一版

---

## 4. 核心概念与页面结构

### 4.1 一轮对话（Turn）

在 DeepSeek 聊天页里，一轮对话的**目标结构**是：

**Uₙ →（可选）Tₙ →（可选）Aₙ**

- **Uₙ**：第 n 轮用户发言（User）
- **Tₙ**：第 n 轮 AI 的“深度思考/推理”块（Think），如果用户关闭深度思考就可能没有
- **Aₙ**：第 n 轮 AI 的“正式回复/Markdown 正文”块（Answer）
- *顺序固定：**用户先说 → AI 才可能有推理 → 再出正文。
- *但要注意：**在“生成中”“网络失败”“AI 还没来得及开始答”的场景下，Tₙ 和 Aₙ **都有可能暂时没有**，页面上就只剩 Uₙ。这是本版必须兼容的场景，**插件不能假设 Aₙ 一定存在**。

### 4.2 我们要滚到的目标是什么？

**优先滚到 Aₙ**（这一轮真正的 AI 正文）。

如果 Aₙ 暂时没有，就按下面的“上行规则”往上滚（见第 7 章）。

### 4.3 消息在 DOM 里的典型结构

真实页面里，一条 AI 消息一般长这样：

```html
<div class="ds-message ...">
  <!-- 可选：深度思考 -->
  <div class="... ds-think-content ...">
    已深度思考（用时 XX 秒）...
  </div>

  <!-- 真正要看的正文 -->
  <div class="ds-markdown ...">
    ... markdown 正文 ...
  </div>
</div>

```

说明：

- **正式回复 Aₙ 通常以 `div.ds-markdown` 呈现**；
- **在生成中/模型或网络异常时，Aₙ 可能暂不可见**（页面上只有 Uₙ，或 Uₙ+Tₙ）；
- 插件**不得**写死那些构建后 hash 样式（类似 `_63c77b1`、`_80d5eb4`）；只允许依赖下面三个：
    - `div.ds-message`（一条消息）
    - `div.ds-think-content`（思考）
    - `div.ds-markdown`（正文）

---

## 5. 用户场景

### 场景 1：长回复回看

我问了个大问题，DeepSeek 回了很长。我中途去别的 tab，回来只看到下面那一大坨。我按一下 `Shift + ↑`，页面就**滚动到这一条真正回答的开始**，我能一口气往下看。

### 场景 2：我正好停在“已深度思考”

这一条是“已深度思考 + 正文”，我现在的屏幕刚好停在“已深度思考”那一块，我按 `Shift + ↑`，**页面不能往下滚到正文**，而是要理解成“我想往上看上一层”，就回到这轮的用户发言。

### 场景 3：我想看我上一句说的

我正在看我说的话（Uₙ），我一直按 `Shift + ↑`，它就会从 Uₙ → Uₙ₋₁ → Uₙ₋₂ … 一直往上滚，到 U₁ 就不动了。

### 场景 4：AI 还没开始答 / 答了一半

我刚问完，AI 还在“思考中”或者网络一时没回来，这时候 Tₙ/Aₙ 都可能没有。按 `Shift + ↑` 也不能报错，这时候我们的场景4就退化成场景3，若能定位到本轮用户发言 Uₙ，则滚动到 Uₙ，否则保持当前位置

---

## 6. 交互入口

1. **键盘**：`Shift + ↑`
    - 本版只实现“向上”
    - 向下（`Shift + ↓`）保留设计不实现
2. **悬浮按钮**：
    - 默认显示在右下角（或右侧中部）一个“↑”的按钮
    - 点击行为 = 触发一次 `Shift + ↑`
    - 本版不做“隐藏悬浮按钮”的个性化设置，放到下版
3. **快捷键冲突**：
    - 如果当前焦点在 input / textarea / contenteditable 里，则插件**不响应**
    - 如果浏览器/页面已有同样的快捷键，插件可以不响应并 `console.log` 一句

---

## 7. 上行滚动规则（最终版）

> 目标：永远向上，永远不为了看正文而向下滚。
> 

### 7.1 前提

- 一轮结构固定：**Uₙ →（可选）Tₙ →（可选）Aₙ**
- `Shift + ↑` 是“回溯”动作
- Aₙ 可能暂时不存在（生成中/失败）

### 7.2 具体规则

1. **当前在 Aₙ 的中段/尾部**
    - 行为：**滚动到这一轮的 Aₙ 顶部**，并应用偏移量（见第 8 章）
    - 说明：这是用户最常见的回看场景
    - 若本轮**暂不存在 Aₙ**，则本条不生效，继续走下面的规则
2. **当前已经在 Aₙ 顶部**
    - 行为：**再按一次就滚动到这一轮的用户发言 Uₙ**
    - 说明：这是“两段式”的动作：先把这一条对齐，再往上看用户说的
    - 若本轮**暂不存在 Aₙ**，则这一条不生效，走 3）或 4）
3. **当前在 Tₙ（本轮深度思考部分）**
    - 行为：**滚动到本轮用户发言 Uₙ**
    - 说明：Tₙ 上面只可能是 Uₙ，Aₙ 在下面；为保持“向上心智”，此处**不得**滚到下面的 Aₙ
    - 若 Uₙ 不存在（极低概率，通常不会发生），则退化为“滚动到上一条可定位消息”
4. **当前在 Uₙ（本轮用户发言）**
    - 若 **n > 1**：滚动到**上一轮用户发言 Uₙ₋₁**
    - 若 **n = 1**：保持不动，可轻提示“已经是第一条对话了”
    - 说明：满足“用户只想看用户自己说的话，快速往前回溯自己的对话轮次“场景
5. **当前还没定位到任何一条（初始态）**
    - 优先：**滚动到最新一轮的 U**
    - 若不存在任何 U 但存在 A → 滚动到**最新一条 A**
    - 若 U / A 都不存在（页面空或加载中）→ **不滚动**，轻提示“暂无可定位对话/请稍后重试”
6. **Aₙ 暂不存在的兜底**
    - 若规则 1）或 2）要滚到 Aₙ，但本轮 Aₙ 暂不可见（生成中/失败），则**直接执行本轮的 Uₙ 的规则**，若能定位到本轮用户发言 Uₙ，则滚动到 Uₙ，否则保持当前位置。不要报错、不要乱滚

---

## 8. 滚动位置 & 偏移

### 8.1 滚动目标

- 滚动的**目标元素**是整个 Uₙ / Tₙ / Aₙ 对应的**容器节点的顶部**，而不是它里面的子元素（比如 markdown 里的一张表）
- 这样无论正文里有表格、代码块、列表，都会从这条回复的开头看起

### 8.2 滚动偏移（Offset）

为了不把内容贴死到屏幕最顶上，用夹逼策略：

```
offset = clamp(24px, viewportHeight * 0.18, 96px)

```

- 正常情况：用视口高度的 18%
- 最少 24px（小屏也能留一点）
- 最多 96px（大屏不会留太大空）

### 8.3 滚动容器选择

1. **优先滚动内部对话容器**：如果 DeepSeek 的聊天区域是一个有自己滚动条的容器（常见是一个中间的 scroll 区），就滚它；
2. **否则回退到 window**：没找到可滚容器，就用 `window.scrollTo(...)`；
3. 偏移规则对两种容器都相同。

---

## 9. DOM 识别规则

1. **获取消息列表**
    - 选择器：`document.querySelectorAll('div.ds-message')`
    - 按 DOM 出现顺序就是从上到下
2. **判断是不是 AI 消息**
    - 一个消息块如果**包含** `div.ds-markdown`，视为 AI 消息
    - 或者**包含** `div.ds-think-content` / 文本含“已深度思考”，也可以视为 AI 消息
    - 其它的（只有纯文本、没有 markdown、也没有 think 的），视为**用户消息**
3. **正文锚点选择**
    - 在同一条消息块内，**优先取第一个不在 `ds-think-content` 里的 `div.ds-markdown` 作为 Aₙ**
    - **若不存在 `div.ds-markdown`，视为“本轮暂无 Aₙ”**（生成中/失败），插件要按上行规则继续向上，而不是报错
4. **深度思考识别**
    - 选择器：`div.ds-think-content`
    - 如 class 发生改变，可兜底为“包含文字 `已深度思考` 的块”
5. **禁止写死 hash 类名**
    - 不允许使用 `_80d5eb4`、`_63c77b1`、`e1675d8b` 这一类构建后的随机类名
    - 只允许使用这三类：`ds-message` / `ds-think-content` / `ds-markdown`
    - 必要时允许“包含文本”兜底

---

## 10. 容器延迟加载 & 重试

DeepSeek 是 SPA，DOM 有可能稍晚才出现，插件不能死循环。

**策略：**

1. 只有当用户**第一次**触发（按键/点按钮）时，才开始找对话容器和消息
2. 如果没找到 → 进入**限次重试**：
    - 最多 5 次
    - 时间间隔：200ms → 400ms → 800ms → 1600ms → 1600ms
    - 总时长不超过 3 秒
3. 5 次还没找到 → 不再重试，轻提示“对话还没加载好，请稍后再试”
4. 后续若通过 `MutationObserver` 发现有新的 `ds-message` 插入，可以再尝试一次识别
5. **成功识别到首条 U/A 后**，如果当前是初始态，再执行第 7.2 节的初始滚动

---

## 11. 悬浮按钮

- V1 **默认显示**悬浮按钮
- 位置：右下角（或右侧中部，具体可交给前端按页面排）
- 点击行为 = 调用与 `Shift + ↑` 完全相同的逻辑
- 本版**不做**“隐藏悬浮按钮”的个性化配置，留到 v1.1 或 v2

---

## 12. Debug / 开发辅助

为了方便你在 Cursor 里调试 DOM 命中，本版允许一个轻量的 debug 模式：

- 触发方式：
    - URL 上带 `?debug=1`，或
    - 在 content script 顶部常量里开启
- 行为：
    - 给识别到的 **Uₙ** 加 `outline: 2px solid blue;`
    - 给识别到的 **Tₙ** 加 `outline: 2px solid orange;`
    - 给识别到的 **Aₙ** 加 `outline: 2px solid green;`
- Debug 模式只在开发环境使用，不影响正式功能

---

## 13. 测试策略

至少要测 4 类页面（你本地其实已经有了）：

1. **有深度思考 + 有正文**
    - 按 `Shift + ↑`：从正文中部 → 滚到正文顶部 → 再按 → 滚到本轮用户
    - 在思考上按 → 滚到本轮用户（不能往下）
2. **无深度思考 + 有正文**
    - 按 `Shift + ↑`：从正文中部 → 滚到正文顶部 → 再按 → 滚到本轮用户
3. **同一页里一会开一会关**
    - 每一条都要能单独识别
4. **正文/思考都暂时没有（生成中/失败）**
    - 按 `Shift + ↑` 不报错，要么滚到本轮用户，要么继续向上回溯

---

## 14. 实现建议（给 Cursor / 开发看的）

1. **manifest.json**
    - `matches` 里写：
        - `"https://chat.deepseek.com/*"`,
        - `"http://localhost/*"`,
        - `"file://*/*"`
    - `content_scripts` 指向 `src/content.js`
2. **content.js 基本结构**
    - 监听 `keydown`
    - 过滤输入框焦点
    - 调用 `handleShiftUp()`
    - `handleShiftUp()` 里做：
        1. 拿到消息列表
        2. 根据当前滚动位置算出“我在哪一条的哪个部分”（Uₙ/Tₙ/Aₙ）
        3. 按第 7 章规则算出目标元素
        4. 找到滚动容器 → `scrollTo({ top: target - offset, behavior: 'smooth' })`
3. **不要发明行为**
    - PRD 没说的不要做：不要自动滚动、不要自动监听 tab focus、不要多站点、不要自动隐藏悬浮

---

## 15. 非目标（Non-goals）

- 不负责解决 DeepSeek 页面本身的样式问题
- 不负责处理用户自定义样式/暗色主题
- 不负责移动端
- 不负责多语言提示（本版中文即可）
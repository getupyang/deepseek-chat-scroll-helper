# DeepSeek Chat Scroll Helper

一个**只针对 DeepSeek 网页版聊天 (`https://chat.deepseek.com/*`)** 的小浏览器插件，用来解决这个很日常但很烦的问题：

> “我跟 AI 聊天，AI 回了一大长段，我去别的 tab 干了会儿别的，回来以后根本不知道这次回复从哪开始看，只能来回滚。”

这个插件做的事就一件：**帮你一键回到“应该看的位置”**。

---

## 功能特点

- **快捷键：`Shift + ↑`**
  1. 如果你现在在本轮 AI 正文（Aₙ）的中段或靠下位置 → 滚动到这条 AI 正文的顶部
  2. 如果你已经在这条 AI 正文（Aₙ）的顶部 → 再按一次会滚动到这轮的用户发言（Uₙ）
  3. 如果你已经在用户发言（Uₙ），而且还有上一轮 → 再按一次会滚到上一轮用户发言（Uₙ₋₁）
  4. 如果你已经是第一轮用户发言 → 不动

- **永远只往上滚**  
  DeepSeek 的一条回复里可能有「深度思考/推理部分」(Tₙ) 和「正式回复/Markdown」(Aₙ)，插件**不会因为你正在看推理部分就把你往下拉到正式回复**，只会上移到本轮用户发言。

- **只对 DeepSeek 生效**  
  插件只对 `https://chat.deepseek.com/*` 注入。开发时可以额外开启 `file://*/*` 方便你在本地测静态页面。

- **无跨 tab / 无云同步**  
  每个页面各自记状态，不做跨 tab、跨设备的同步，保持简单。

---

## 安装（开发者模式）

1. 下载本仓库到本地（`git clone ...` 或者直接下载 zip 解压）
2. 打开 Chrome → `chrome://extensions/`
3. 右上角打开「开发者模式」
4. 点击「加载已解压的扩展程序」
5. 选中本项目文件夹
6. 打开 `https://chat.deepseek.com/`，找到一条比较长的 AI 回复，试试 `Shift + ↑`

每次你改了代码（尤其是 `src/content.js`），记得：
- 在扩展页面点一下“刷新/Reload”
- 再刷新一下 DeepSeek 的页面

---

## 适配的页面结构

插件是按 DeepSeek 当前的 DOM 结构写的，大致识别逻辑是：

- 一条对话轮次 = **Uₙ →（可选）Tₙ →（可选）Aₙ**
- 用户发言 → 容器里带 `ds-message`
- 深度思考 → 容器里带 `ds-think-content`
- 正文回复 → 容器里带 `ds-markdown`

如果未来 DeepSeek 改了 class 名字或 DOM 层级，你可以用仓库里的示例页面来回归（见 `test_pages/sample-deepseek.htm`），或者自己再抓一份新的 HTML 来测。

---

## 已实现的 PRD 关键点

- ✅ `Shift + ↑` 两段式回溯：Aₙ 中段 → Aₙ 顶部 → Uₙ
- ✅ Uₙ 向上滚：Uₙ → Uₙ₋₁ → … → U₁
- ✅ Tₙ（深度思考）只往上不往下：在 Tₙ 按键只会回到 Uₙ，不会滚到 Aₙ
- ✅ Aₙ 缺失时（AI 正在生成 / 网络失败）会优雅退化到 Uₙ
- ✅ 当前焦点在 input / textarea / contenteditable 时不响应快捷键（避免打字时误触）

还没做 / 准备以后做的：
- ⏳ 悬浮按钮显隐 / 自定义快捷键
- ⏳ 多站点支持（现在只做 DeepSeek）
- ⏳ 视觉上的滚动动画优化

---

## 本地测试页面

仓库里有一个示例页面：

- `test_pages/sample-deepseek.htm`

这是一个从 DeepSeek 导出的静态页面，用来在本地离线测试插件的 DOM 识别逻辑。  
**真正的个人聊天页面建议不要提交到仓库里**，本项目的 `.gitignore` 已经忽略了 `test_pages/*`，只保留一个 sample。

---

## 目录结构

```text
.
├── manifest.json        # Chrome MV3 配置
├── src/
│   └── content.js       # 核心逻辑：监听 Shift+↑，识别 U/T/A，滚动
├── PRD.md               # 产品需求，定义了每一步应该怎么滚
├── Project_rules.md     # 项目内固定规则（比如不做自动滚动、不做多站点）
├── test_pages/
│   └── sample-deepseek.htm  # 本地测试用的示例页面
├── .gitignore
└── README.md

---
## 开发补充（Cursor 生成版）
# DeepSeek 网页版对话定位插件

## 项目简介

这是一个 Chrome Manifest V3 浏览器插件，专门为 DeepSeek 网页版聊天页面设计。当用户面对 AI 的长回复时，可以通过 `Shift + ↑` 快捷键或点击悬浮按钮，快速滚动到当前对话轮次中"应该看的位置"（通常是 AI 正文的开始部分），跳过可选的"深度思考"内容，提升阅读体验。

**作用范围：** 仅对 `https://chat.deepseek.com/*` 页面生效。

## 关键约束

本项目严格按照 `PRD.md` 和 `Project_rules.md` 执行，**不允许实现以下功能**：

- ❌ 不做自动滚动（tab 切换回来时不会自动滚动）
- ❌ 不做多站点支持（仅 DeepSeek，不支持 ChatGPT、Claude、Poe 等）
- ❌ 不做快捷键自定义
- ❌ 不做横向滚动
- ❌ 不做悬浮按钮的隐藏/个性化配置（留到下版）

**技术约束：**
- 只能使用 DOM 类名：`ds-message`、`ds-think-content`、`ds-markdown`
- 禁止使用构建后的随机 hash 类名（如 `_80d5eb4`、`_63c77b1`）
- 当前焦点在 `input` / `textarea` / `contenteditable` 时，插件不响应快捷键

## 目录结构

```
.
├── manifest.json          # Chrome MV3 插件清单文件
├── src/
│   └── content.js        # 内容脚本，实现核心定位逻辑
├── PRD.md                # 产品需求文档（最高优先级）
├── Project_rules.md      # 项目固定规则（等同于 PRD.md 优先级）
├── fixtures/             # 测试用的本地 HTML 文件
└── README.md             # 本文件
```

## 开发期域名配置

在开发测试阶段，`manifest.json` 中的 `content_scripts.matches` 需要包含以下三个域名：

- `https://chat.deepseek.com/*` - 生产环境
- `http://localhost/*` - 本地开发服务器测试
- `file://*/*` - 本地导出的 HTML 文件测试

**原因：**
1. **本地服务器测试**：开发者可以在本地启动一个模拟 DeepSeek 页面的测试服务器，方便快速迭代和调试，无需每次都部署到生产环境。
2. **本地 HTML 文件测试**：可以使用 DeepSeek 导出的 HTML 文件（保存在 `fixtures/` 目录）进行离线测试，不依赖网络连接和实际 DeepSeek 服务。

生产版本发布时，可以只保留 `https://chat.deepseek.com/*`。

## 核心交互逻辑

### 上行滚动顺序

按下 `Shift + ↑` 时的滚动顺序（永远向上，不向下）：

1. **在 Aₙ 中段/尾部** → 滚到 Aₙ 顶部
2. **在 Aₙ 顶部** → 再按一次滚到本轮用户发言 Uₙ
3. **在 Tₙ（深度思考）** → 滚到本轮用户发言 Uₙ（**不得向下滚到 Aₙ**）
4. **在 Uₙ** → 滚到上一轮用户发言 Uₙ₋₁（n>1）或保持不动（n=1）

### 键盘事件处理

在监听 `keydown` 事件时，**必须先判断当前焦点**：

```javascript
// 伪代码示例
if (isInputFocused(input / textarea / contenteditable)) {
  return; // 不响应，避免与用户输入冲突
}
```

这样可以避免在用户正在输入时误触发滚动。

## 测试场景

开发时必须覆盖以下 4 个场景：

### 场景 1：有深度思考 + 有正文
- 按 `Shift + ↑`：从正文中部 → 滚到正文顶部 → 再按 → 滚到本轮用户
- 在"深度思考"上按 → 滚到本轮用户（**不能往下滚到正文**）

### 场景 2：无深度思考 + 有正文
- 按 `Shift + ↑`：从正文中部 → 滚到正文顶部 → 再按 → 滚到本轮用户

### 场景 3：同一页里一会开一会关
- 页面中某些消息有深度思考，某些没有
- 每一条都要能单独正确识别和处理

### 场景 4：AI 还没开始答 / 答了一半（Aₙ 暂不存在）
- 按 `Shift + ↑` **不得报错**
- 行为应退化成"当前在看 Uₙ"的场景：若能定位到本轮用户发言 Uₙ，则滚动到 Uₙ；若已是最早的对话，则保持当前位置不动

## 消息结构

一轮对话的结构：**Uₙ →（可选）Tₙ →（可选）Aₙ**

- **Uₙ**：用户发言（User）
- **Tₙ**：深度思考（Think，可选）
- **Aₙ**：AI 正文（Answer，可选，可能因生成中/失败而暂不存在）

插件必须兼容 Aₙ 缺失的情况，不能假设 Aₙ 一定存在。

## 相关文档

- `PRD.md` - 详细产品需求文档，包含完整的上行滚动规则、DOM 识别规则、偏移量计算等
- `Project_rules.md` - 项目固定规则，与 PRD.md 同等优先级

---

**开发原则：以 PRD.md 为最高优先级，严格按照文档实现，不添加文档未要求的功能。**

